"use strict";const PUBLIC_API="https://public.api.bsky.app/xrpc",SEARCH_API="/api/search",INITIAL_RENDER_LIMIT=200,RENDER_STEP=100,SEARCH_DEBOUNCE_MS=300,INITIAL_MAX_PAGES=2,SEARCH_CACHE_TTL_MS=3e4,didCache=new Map,searchCache=new Map;let searchDebounceTimer=null,allPosts=[],currentCursors={},rawSearchTerms=[],searchTerms=[],searchSort="top",minLikes=10,timeFilterHours=24,isLoading=!1,isRefreshing=!1,pendingSearch=!1,renderLimit=200,autoRefreshEnabled=!1,refreshIntervalMs=3e5,refreshTimerId=null,refreshCountdownId=null,nextRefreshAt=null,lastRefreshAt=null,lastRefreshNewCount=null,lastRefreshError=null,pendingPosts=[],newPostUris=new Set,clearHighlightsTimeout=null,allQuotes=[],quoteSort="likes",isQuoteLoading=!1,quoteCursor=null,quoteSeenCursors=new Set,quoteTotalCount=null,activeQuoteUri=null;const termsInput=document.getElementById("terms"),minLikesInput=document.getElementById("minLikes"),timeFilterSelect=document.getElementById("timeFilter"),sortSelect=document.getElementById("sortSelect"),searchBtn=document.getElementById("searchBtn"),statusDiv=document.getElementById("status"),newPostsDiv=document.getElementById("newPosts"),resultsDiv=document.getElementById("results"),autoRefreshToggle=document.getElementById("autoRefreshToggle"),refreshIntervalSelect=document.getElementById("refreshInterval"),refreshStateDiv=document.getElementById("refreshState"),refreshLastDiv=document.getElementById("refreshLast"),refreshNextDiv=document.getElementById("refreshNext"),themeSelect=document.getElementById("themeSelect"),expandTermsToggle=document.getElementById("expandTermsToggle"),expandSummary=document.getElementById("expandSummary"),quoteForm=document.getElementById("quoteForm"),postUrlInput=document.getElementById("postUrl"),quoteSearchBtn=document.getElementById("quoteSearchBtn"),quoteStatusDiv=document.getElementById("quoteStatus"),quoteTabs=document.getElementById("quoteTabs"),quoteOriginalDiv=document.getElementById("quoteOriginal"),quoteCountDiv=document.getElementById("quoteCount"),quoteResultsDiv=document.getElementById("quoteResults"),quoteLoadMoreDiv=document.getElementById("quoteLoadMore");function setText(e,t){e.textContent=t}function isValidBskyUrl(e){if(!e)return!1;try{const t=new URL(e);return"https:"===t.protocol&&("bsky.app"===t.hostname||t.hostname.endsWith(".bsky.app")||"cdn.bsky.app"===t.hostname||t.hostname.endsWith(".cdn.bsky.app"))}catch{return!1}}const THEME_STORAGE_KEY="bsky-theme",prefersDarkScheme=window.matchMedia("(prefers-color-scheme: dark)");function getSystemTheme(){return prefersDarkScheme.matches?"dark":"light"}function applyThemePreference(e){const t="system"===e?getSystemTheme():e;document.documentElement.dataset.theme=t}function initTheme(){const e=localStorage.getItem("bsky-theme")||"system";themeSelect.value=e,applyThemePreference(e)}function updateURLWithParams(e){const t=window.location.pathname+(e.toString()?"?"+e.toString():"");window.history.replaceState({},"",t)}function setQueryParam(e,t,n){n?e.set(t,n):e.delete(t)}function updateSearchURL(){const e=new URLSearchParams(window.location.search);setQueryParam(e,"terms",termsInput.value.trim()),setQueryParam(e,"minLikes",minLikesInput.value),setQueryParam(e,"time","24"!==timeFilterSelect.value?timeFilterSelect.value:""),setQueryParam(e,"sort","top"!==searchSort?searchSort:""),setQueryParam(e,"expand",expandTermsToggle.checked?"1":""),updateURLWithParams(e)}function updateQuoteURL(){const e=new URLSearchParams(window.location.search),t=postUrlInput.value.trim();setQueryParam(e,"post",t),t&&"likes"!==quoteSort?e.set("sort",quoteSort):e.delete("sort"),updateURLWithParams(e)}function updateQuoteTabs(){quoteTabs.querySelectorAll(".quote-tab").forEach(e=>{e.classList.toggle("active",e.dataset.sort===quoteSort)})}function initFromURL(){const e=new URLSearchParams(window.location.search);if(e.get("terms")&&(termsInput.value=e.get("terms")),e.get("minLikes")&&(minLikesInput.value=e.get("minLikes")),e.get("time")){const t=e.get("time");["1","6","12","24","48","168"].includes(t)&&(timeFilterSelect.value=t)}if(e.get("sort")){const t=e.get("sort");["top","latest"].includes(t)&&(sortSelect.value=t)}searchSort="latest"===sortSelect.value?"latest":"top","1"===e.get("expand")&&(expandTermsToggle.checked=!0);const t=e.get("post"),n=e.get("sort");n&&["likes","recent","oldest"].includes(n)&&(quoteSort=n,updateQuoteTabs()),t&&(postUrlInput.value=t,performQuoteSearch()),updateExpansionSummary()}function showStatus(e,t="info"){statusDiv.className="status "+t,setText(statusDiv,e),statusDiv.style.display="block"}function hideStatus(){statusDiv.style.display="none"}function showQuoteStatus(e,t="info"){quoteStatusDiv.className="status "+t,setText(quoteStatusDiv,e),quoteStatusDiv.style.display="block"}function hideQuoteStatus(){quoteStatusDiv.style.display="none"}function normalizeTerm(e){let t=e.trim();return(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1).trim()),t}function expandSearchTerms(e,t){const n=[],s=new Set,r=e=>{const t=e.trim();if(!t)return;const r=t.toLowerCase();s.has(r)||(s.add(r),n.push(t))};return e.forEach(e=>{const n=normalizeTerm(e);if(n&&(r(n),t)){const e=n.split(/\s+/).filter(Boolean);e.length>1&&e.forEach(r)}}),n}function updateExpansionSummary(){const e=termsInput.value.trim();if(!e)return void(expandSummary.textContent="Enter terms to preview expansion.");const t=e.split(",").map(normalizeTerm).filter(Boolean);if(0===t.length)return void(expandSummary.textContent="Enter terms to preview expansion.");if(!expandTermsToggle.checked)return void(expandSummary.textContent=`Expansion is off. Searching only: ${t.join(", ")}`);const n=expandSearchTerms(t,!0),s=new Set(t.map(e=>e.toLowerCase()));0!==n.filter(e=>!s.has(e.toLowerCase())).length?expandSummary.textContent=`Typed: ${t.join(", ")}. Expanded: ${n.join(", ")}`:expandSummary.textContent=`No multi-word phrases detected. Searching: ${t.join(", ")}`}function getSearchCacheKey(e,t,n){return`${e}|${t||""}|${n}`}function getCachedSearch(e){const t=searchCache.get(e);return t?Date.now()-t.timestamp>3e4?(searchCache.delete(e),null):t.data:null}async function searchTerm(e,t=null,n=searchSort){const s="latest"===n?"latest":"top",r=getSearchCacheKey(e,t,s),o=getCachedSearch(r);if(o)return o;const a=new URLSearchParams({term:e,sort:s});t&&a.set("cursor",t);const i=await fetch(`${SEARCH_API}?${a}`);if(!i.ok){let t=`Search failed for "${e}": ${i.status}`;try{const e=await i.json();e.message&&(t+=` - ${e.message}`),e.error&&(t+=` - ${e.error}`)}catch(e){}throw new Error(t)}const l=await i.json();return searchCache.set(r,{data:l,timestamp:Date.now()}),l}async function fetchAllPostsForTerm(e,t=2,n=searchSort){let s=[],r=null,o=0;for(;o<t;){const t=await searchTerm(e,r,n);if(t.posts&&t.posts.length>0){const n=t.posts.map(t=>({...t,matchedTerm:e}));s=s.concat(n)}if(!t.cursor)break;r=t.cursor,o++}return currentCursors[e]=r,s}async function fetchLatestPostsForTerm(e,t=searchSort){const n=await searchTerm(e,null,t);return n.posts&&n.posts.length>0?n.posts.map(t=>({...t,matchedTerm:e})):[]}function deduplicatePosts(e){const t=new Map;for(const n of e){const e=n.uri;if(t.has(e)){const s=t.get(e);s.matchedTerms||(s.matchedTerms=[s.matchedTerm]),s.matchedTerms.includes(n.matchedTerm)||s.matchedTerms.push(n.matchedTerm)}else t.set(e,n)}return Array.from(t.values()).map(e=>(e.matchedTerms||(e.matchedTerms=[e.matchedTerm]),e))}function filterByLikes(e,t){return e.filter(e=>(e.likeCount||0)>=t)}function filterByDate(e,t){const n=new Date;return n.setHours(n.getHours()-t),e.filter(e=>new Date(e.indexedAt)>=n)}function sortPosts(e,t=searchSort){const n=[...e];return"latest"===t?(n.sort((e,t)=>getPostTimestamp(t)-getPostTimestamp(e)),n):(n.sort((e,t)=>(t.likeCount||0)-(e.likeCount||0)),n)}function formatRelativeTime(e){const t=new Date(e),n=new Date-t,s=Math.floor(n/6e4),r=Math.floor(n/36e5);return s<1?"just now":s<60?`${s}m ago`:r<24?`${r}h ago`:t.toLocaleDateString()}function getPostUrl(e){const t=e.uri.split("/"),n=t[t.length-1],s=e.author.handle;return/^[a-zA-Z0-9._-]+$/.test(s)&&/^[a-zA-Z0-9]+$/.test(n)?`https://bsky.app/profile/${encodeURIComponent(s)}/post/${encodeURIComponent(n)}`:null}function formatDateTime(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleString()}function getPostTimestamp(e){const t=e.record?.createdAt||e.indexedAt,n=new Date(t).getTime();return Number.isNaN(n)?0:n}function formatTime(e){const t=e instanceof Date?e:new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function formatDuration(e){const t=Math.max(0,Math.floor(e/1e3)),n=Math.floor(t/60),s=t%60;if(n>=60){return`${Math.floor(n/60)}h ${n%60}m`}return`${n}:${String(s).padStart(2,"0")}`}function updateRefreshInterval(){const e=parseInt(refreshIntervalSelect.value,10);refreshIntervalMs=Number.isFinite(e)&&e>0?6e4*e:3e5}function resetRenderLimit(){renderLimit=200}function increaseRenderLimit(e=100){renderLimit=Math.min(allPosts.length,renderLimit+e)}function clearRefreshTimers(){refreshTimerId&&(clearTimeout(refreshTimerId),refreshTimerId=null),refreshCountdownId&&(clearInterval(refreshCountdownId),refreshCountdownId=null)}function updateRefreshMeta(){if(refreshStateDiv.textContent=autoRefreshEnabled?isRefreshing?"Refreshing...":"Auto-refresh on":"Auto-refresh off",lastRefreshError)refreshLastDiv.textContent=`Last update failed: ${lastRefreshError}`;else if(lastRefreshAt){const e=Number.isFinite(lastRefreshNewCount)?` (+${lastRefreshNewCount} new)`:"";refreshLastDiv.textContent=`Last updated: ${formatTime(lastRefreshAt)}${e}`}else refreshLastDiv.textContent="Last updated: --";refreshNextDiv.textContent=autoRefreshEnabled&&nextRefreshAt?`Next refresh in ${formatDuration(nextRefreshAt-Date.now())}`:""}function scheduleNextRefresh(){if(clearRefreshTimers(),!autoRefreshEnabled)return nextRefreshAt=null,void updateRefreshMeta();nextRefreshAt=Date.now()+refreshIntervalMs,refreshTimerId=setTimeout(runAutoRefresh,refreshIntervalMs),refreshCountdownId=setInterval(updateRefreshMeta,1e3),updateRefreshMeta()}function clearNewPostHighlights(){newPostUris.clear(),clearHighlightsTimeout&&(clearTimeout(clearHighlightsTimeout),clearHighlightsTimeout=null)}function scheduleNewPostHighlightClear(){clearHighlightsTimeout&&clearTimeout(clearHighlightsTimeout),clearHighlightsTimeout=setTimeout(()=>{newPostUris.clear(),clearHighlightsTimeout=null,renderResults()},8e3)}function updateQuoteCount(){if(Number.isFinite(quoteTotalCount)){const e=quoteTotalCount;return void(quoteCountDiv.textContent=`Loaded ${allQuotes.length} of ${e} quote${1!==e?"s":""}`)}quoteCountDiv.textContent=`Loaded ${allQuotes.length} quote${1!==allQuotes.length?"s":""}`}function trackQuoteCursor(e){return e?quoteSeenCursors.has(e)?null:(quoteSeenCursors.add(e),e):null}function parseBlueskyPostUrl(e){let t;try{t=new URL(e)}catch(e){throw new Error("Please enter a valid URL.")}if("https:"!==t.protocol||"bsky.app"!==t.hostname)throw new Error("URL must be from https://bsky.app");const n=t.pathname.split("/").filter(Boolean);if(n.length<4||"profile"!==n[0]||"post"!==n[2])throw new Error("Use https://bsky.app/profile/{handle}/post/{postId}");const s=n[1],r=n[3];if(!s||!r)throw new Error("URL is missing a handle or post ID.");return{actor:s.startsWith("did:")||s.includes(".")?s:`${s}.bsky.social`,postId:r,rawHandle:s}}async function fetchDid(e){const t=e.toLowerCase();if(didCache.has(t))return didCache.get(t);const n=await fetch(`${PUBLIC_API}/app.bsky.actor.getProfile?actor=${encodeURIComponent(e)}`);if(!n.ok)throw new Error(`Profile fetch failed: ${n.status}`);const s=await n.json(),r=s.did||s.profile?.did;if(!r)throw new Error("Could not resolve DID for that handle.");return didCache.set(t,r),r}async function fetchOriginalPost(e){const t=await fetch(`${PUBLIC_API}/app.bsky.feed.getPosts?uris=${encodeURIComponent(e)}`);if(!t.ok)throw new Error(`Original post fetch failed: ${t.status}`);const n=await t.json();if(!n.posts||0===n.posts.length)throw new Error("Post not found.");return n.posts[0]}async function fetchQuotesPage(e,t=null){let n=`${PUBLIC_API}/app.bsky.feed.getQuotes?uri=${encodeURIComponent(e)}&limit=100`;t&&(n+=`&cursor=${encodeURIComponent(t)}`);const s=await fetch(n);if(!s.ok)throw new Error(`Quotes fetch failed: ${s.status}`);const r=await s.json();return{posts:Array.isArray(r.posts)?r.posts:[],cursor:r.cursor||null}}function sortQuotes(e,t){const n=[...e];switch(t){case"likes":n.sort((e,t)=>(t.likeCount||0)-(e.likeCount||0));break;case"recent":n.sort((e,t)=>getPostTimestamp(t)-getPostTimestamp(e));break;case"oldest":n.sort((e,t)=>getPostTimestamp(e)-getPostTimestamp(t))}return n}function createQuoteOriginalElement(e){const t=document.createElement("div");t.className="quote-original";const n=document.createElement("div");n.className="label",n.textContent="Original Post",t.appendChild(n);const s=document.createElement("div");s.className="quote-author";const r=e.author.displayName||e.author.handle;s.textContent=`${r} (@${e.author.handle})`,t.appendChild(s);const o=document.createElement("div");o.className="quote-meta";const a=document.createElement("span");a.textContent=formatDateTime(e.record?.createdAt||e.indexedAt),o.appendChild(a),t.appendChild(o);const i=getPostUrl(e);if(i){const e=document.createElement("div");e.className="link-actions";const n=document.createElement("a");n.className="thread-link",n.href=i,n.target="_blank",n.rel="noopener noreferrer",n.textContent="View on Bluesky",e.appendChild(n),t.appendChild(e)}const l=document.createElement("div");l.className="quote-text",l.textContent=e.record?.text||"",t.appendChild(l);const c=document.createElement("div");c.className="quote-stats";const u=document.createElement("span");u.className="quote-stat likes",u.textContent=`â™¥ ${e.likeCount||0}`,c.appendChild(u);const d=document.createElement("span");d.className="quote-stat reposts",d.textContent=`â†» ${e.repostCount||0}`,c.appendChild(d);const m=document.createElement("span");m.className="quote-stat replies",m.textContent=`ðŸ’¬ ${e.replyCount||0}`,c.appendChild(m);const h=document.createElement("span");return h.className="quote-stat",h.textContent=`Quotes ${e.quoteCount||0}`,c.appendChild(h),t.appendChild(c),t}function createQuotePostElement(e,t){const n=document.createElement("div");n.className="quote-post depth-"+(t%8+1);const s=document.createElement("div");s.className="quote-author";const r=e.author.displayName||e.author.handle;s.textContent=`${r} (@${e.author.handle})`,n.appendChild(s);const o=document.createElement("div");o.className="quote-meta";const a=document.createElement("span");a.textContent=formatDateTime(e.record?.createdAt||e.indexedAt),o.appendChild(a),n.appendChild(o);const i=getPostUrl(e);if(i){const e=document.createElement("div");e.className="link-actions";const t=document.createElement("a");t.className="thread-link",t.href=i,t.target="_blank",t.rel="noopener noreferrer",t.textContent="View on Bluesky",e.appendChild(t),n.appendChild(e)}const l=document.createElement("div");l.className="quote-text",l.textContent=e.record?.text||"",n.appendChild(l);const c=document.createElement("div");c.className="quote-stats";const u=document.createElement("span");u.className="quote-stat likes",u.textContent=`â™¥ ${e.likeCount||0}`,c.appendChild(u);const d=document.createElement("span");d.className="quote-stat reposts",d.textContent=`â†» ${e.repostCount||0}`,c.appendChild(d);const m=document.createElement("span");return m.className="quote-stat replies",m.textContent=`ðŸ’¬ ${e.replyCount||0}`,c.appendChild(m),n.appendChild(c),n}function renderQuoteLoadMore(){if(quoteLoadMoreDiv.textContent="",!quoteCursor)return;const e=document.createElement("button");e.type="button",e.className="load-more",e.id="quoteLoadMoreBtn",e.textContent="Load More Quotes",e.disabled=isQuoteLoading,e.addEventListener("click",loadMoreQuotes),quoteLoadMoreDiv.appendChild(e)}function renderQuoteResults(){if(quoteResultsDiv.textContent="",0===allQuotes.length){const e=document.createElement("div");return e.className="no-quotes",e.textContent="No quotes found for this post.",void quoteResultsDiv.appendChild(e)}sortQuotes(allQuotes,quoteSort).forEach((e,t)=>{quoteResultsDiv.appendChild(createQuotePostElement(e,t))})}async function loadMoreQuotes(){if(isQuoteLoading||!activeQuoteUri||!quoteCursor)return;isQuoteLoading=!0;const e=document.getElementById("quoteLoadMoreBtn");e&&(e.disabled=!0,e.textContent="Loading...");try{const e=await fetchQuotesPage(activeQuoteUri,quoteCursor);e.posts.length>0&&(allQuotes=allQuotes.concat(e.posts)),quoteCursor=trackQuoteCursor(e.cursor),updateQuoteCount(),renderQuoteResults(),hideQuoteStatus()}catch(e){console.error("Load more quotes error:",e),showQuoteStatus(`Error loading more quotes: ${e.message}`,"error")}finally{isQuoteLoading=!1,renderQuoteLoadMore()}}async function performQuoteSearch(){if(isQuoteLoading)return;const e=postUrlInput.value.trim();if(e){isQuoteLoading=!0,quoteSearchBtn.disabled=!0,showQuoteStatus("Loading quotes...","loading"),quoteTabs.style.display="none",quoteResultsDiv.textContent="",quoteOriginalDiv.textContent="",quoteCountDiv.textContent="",quoteLoadMoreDiv.textContent="",allQuotes=[],quoteCursor=null,quoteSeenCursors=new Set,quoteTotalCount=null,activeQuoteUri=null,updateQuoteURL();try{const{actor:t,postId:n}=parseBlueskyPostUrl(e),s=`at://${await fetchDid(t)}/app.bsky.feed.post/${n}`;activeQuoteUri=s;const[r,o]=await Promise.all([fetchOriginalPost(s),fetchQuotesPage(s)]);allQuotes=o.posts,quoteCursor=trackQuoteCursor(o.cursor),Number.isFinite(r.quoteCount)&&r.quoteCount>=allQuotes.length&&(quoteTotalCount=r.quoteCount),quoteOriginalDiv.appendChild(createQuoteOriginalElement(r)),updateQuoteCount(),quoteTabs.style.display="flex",hideQuoteStatus(),renderQuoteResults()}catch(e){console.error("Quote search error:",e),showQuoteStatus(`Error: ${e.message}`,"error")}finally{isQuoteLoading=!1,quoteSearchBtn.disabled=!1,renderQuoteLoadMore()}}else showQuoteStatus("Please enter a Bluesky post URL.","error")}function isReplyPost(e){return!!e.record?.reply}async function fetchPostThread(e){const t=new URLSearchParams({uri:e,depth:"0",parentHeight:"100"}),n=await fetch(`${PUBLIC_API}/app.bsky.feed.getPostThread?${t}`);if(!n.ok)throw new Error(`Failed to fetch thread: ${n.status}`);return n.json()}function extractParentChain(e){const t=[];let n=e.thread?.parent;for(;n?.post;)t.unshift(n.post),n=n.parent;return t}function createThreadParentElement(e){const t=document.createElement("div");t.className="thread-parent";const n=document.createElement("div");if(n.className="thread-parent-header",e.author.avatar&&isValidBskyUrl(e.author.avatar)){const t=document.createElement("img");t.className="thread-parent-avatar",t.src=e.author.avatar,t.alt="",t.loading="lazy",n.appendChild(t)}else{const e=document.createElement("div");e.className="thread-parent-avatar",n.appendChild(e)}const s=document.createElement("span");s.className="thread-parent-author",s.textContent=e.author.displayName||e.author.handle,n.appendChild(s);const r=document.createElement("span");r.className="thread-parent-handle",r.textContent=`@${e.author.handle}`,n.appendChild(r);const o=document.createElement("span");o.className="thread-parent-time",o.textContent=formatRelativeTime(e.indexedAt),n.appendChild(o),t.appendChild(n);const a=document.createElement("div");return a.className="thread-parent-text",a.textContent=e.record?.text||"",t.appendChild(a),t}function createThreadContextElement(e){const t=document.createElement("div");t.className="thread-context";const n=document.createElement("div");return n.className="thread-label",n.textContent="Thread context",t.appendChild(n),e.forEach(e=>{t.appendChild(createThreadParentElement(e))}),t}function removeThreadContexts(e){let t=e.previousElementSibling,n=!1;for(;t?.classList.contains("thread-context");){const e=t;t=t.previousElementSibling,e.remove(),n=!0}return n}async function toggleThread(e,t){const n=t.querySelector(".thread-link");if(n&&"true"!==n.dataset.loading)if(removeThreadContexts(t))n.textContent="View Thread";else{n.dataset.loading="true",n.disabled=!0,n.textContent="Loading...";try{const s=extractParentChain(await fetchPostThread(e.uri));if(0===s.length)return n&&(n.textContent="No parent posts found"),void setTimeout(()=>{n&&(n.textContent="View Thread")},2e3);const r=createThreadContextElement(s);t.parentNode.insertBefore(r,t),n.textContent="Hide Thread"}catch(e){console.error("Thread fetch error:",e),n.textContent="Failed to load thread",setTimeout(()=>{n.textContent="View Thread"},2e3)}finally{n.dataset.loading="false",n.disabled=!1}}}function createHighlightedText(e,t){const n=document.createDocumentFragment();if(!e)return n;const s=t.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),r=new RegExp(`(${s.join("|")})`,"gi");return e.split(r).forEach(e=>{if(t.some(t=>e.toLowerCase()===t.toLowerCase())){const t=document.createElement("span");t.className="highlight",t.textContent=e,n.appendChild(t)}else n.appendChild(document.createTextNode(e))}),n}function createPostElement(e){const t=getPostUrl(e),n=e.author.handle,s=e.author.displayName||n,r=e.record?.text||"",o=document.createElement("div");o.className="post",newPostUris.has(e.uri)&&o.classList.add("new-post");const a=document.createElement("div");a.className="search-terms",e.matchedTerms.forEach(e=>{const t=document.createElement("span");t.className="term-tag",t.textContent=e,a.appendChild(t)}),o.appendChild(a);const i=document.createElement("div");if(i.className="post-header",e.author.avatar&&isValidBskyUrl(e.author.avatar)){const t=document.createElement("img");t.className="avatar",t.src=e.author.avatar,t.alt="",t.loading="lazy",i.appendChild(t)}else{const e=document.createElement("div");e.className="avatar",i.appendChild(e)}const l=document.createElement("div");l.className="author-info";const c=`https://bsky.app/profile/${encodeURIComponent(n)}`,u=document.createElement("a");u.className="display-name",u.href=c,u.target="_blank",u.rel="noopener noreferrer",u.textContent=s,l.appendChild(u);const d=document.createElement("span");d.className="handle",d.textContent=`@${n}`,l.appendChild(d),i.appendChild(l);const m=document.createElement("span");m.className="post-time",m.textContent=formatRelativeTime(e.indexedAt),i.appendChild(m),o.appendChild(i);const h=document.createElement("div");if(h.className="post-text",h.appendChild(createHighlightedText(r,searchTerms)),o.appendChild(h),"app.bsky.embed.images#view"===e.embed?.$type&&e.embed.images){const t=document.createElement("div");t.className="post-images "+(1===e.embed.images.length?"single":"multiple"),e.embed.images.forEach(e=>{if(e.thumb&&isValidBskyUrl(e.thumb)){const n=document.createElement("img");n.className="post-image",n.src=e.thumb,n.alt=e.alt||"",n.loading="lazy",t.appendChild(n)}}),t.children.length>0&&o.appendChild(t)}const p=document.createElement("div");p.className="post-stats";const f=document.createElement("span");f.className="stat likes",f.textContent=`â™¥ ${e.likeCount||0}`,p.appendChild(f);const g=document.createElement("span");g.className="stat",g.textContent=`â†» ${e.repostCount||0}`,p.appendChild(g);const C=document.createElement("span");C.className="stat",C.textContent=`ðŸ’¬ ${e.replyCount||0}`,p.appendChild(C),o.appendChild(p);const E=document.createElement("div");if(E.className="link-actions",t)if(isReplyPost(e)){const n=document.createElement("button");n.className="thread-link",n.textContent="View Thread",n.addEventListener("click",()=>toggleThread(e,o)),E.appendChild(n);const s=document.createElement("a");s.className="thread-link",s.href=t,s.target="_blank",s.rel="noopener noreferrer",s.textContent="View on Bluesky",E.appendChild(s)}else{const e=document.createElement("a");e.className="thread-link",e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.textContent="View Replies â†’",E.appendChild(e)}return o.appendChild(E),o}function renderResults(){if(resultsDiv.textContent="",0===allPosts.length){const e=document.createElement("div");e.className="no-results";const t=document.createElement("p");t.textContent=pendingPosts.length>0?"New posts are waiting above.":"No posts found matching your criteria.",e.appendChild(t);const n=document.createElement("p");return n.textContent=pendingPosts.length>0?'Use "Add to results" to merge them into the main list.':"Try different search terms or lower the minimum likes.",e.appendChild(n),void resultsDiv.appendChild(e)}const e=document.createElement("div");e.className="results-header";const t=document.createElement("span");t.className="results-count";const n=allPosts.length,s=Math.min(renderLimit,n),r=1===n?"post":"posts";t.textContent=s<n?`Showing ${s} of ${n} ${r}`:`${n} ${r} found`,e.appendChild(t);const o=document.createElement("span");o.textContent="latest"===searchSort?"Sorted by time (newest first)":"Sorted by likes (high to low)",e.appendChild(o),resultsDiv.appendChild(e);if(allPosts.slice(0,s).forEach(e=>{resultsDiv.appendChild(createPostElement(e))}),s<n){const e=document.createElement("button");e.className="load-more",e.id="showMoreBtn";const t=n-s;e.textContent=t<=100?1===t?"Show 1 more loaded result":`Show ${t} more loaded results`:"Show 100 more loaded results",e.addEventListener("click",()=>{increaseRenderLimit(),renderResults()}),resultsDiv.appendChild(e)}if(Object.values(currentCursors).some(e=>null!==e)){const e=document.createElement("button");e.className="load-more",e.id="loadMoreBtn",e.textContent="Load More Results",e.addEventListener("click",loadMore),resultsDiv.appendChild(e)}}function renderNewPosts(){if(newPostsDiv.textContent="",0===pendingPosts.length)return void newPostsDiv.classList.add("hidden");newPostsDiv.classList.remove("hidden");const e=document.createElement("div");e.className="new-posts-header";const t=document.createElement("div");t.className="new-posts-title",t.textContent=`${pendingPosts.length} new post${1!==pendingPosts.length?"s":""} from auto-refresh`,e.appendChild(t);const n=document.createElement("div");n.className="new-posts-actions";const s=document.createElement("button");s.type="button",s.className="button-small",s.textContent="Add to results",s.addEventListener("click",mergePendingPosts),n.appendChild(s);const r=document.createElement("button");r.type="button",r.className="button-secondary button-small",r.textContent="Dismiss",r.addEventListener("click",dismissPendingPosts),n.appendChild(r),e.appendChild(n),newPostsDiv.appendChild(e);const o=document.createElement("div");o.className="new-posts-list";[...pendingPosts].sort((e,t)=>getPostTimestamp(t)-getPostTimestamp(e)).forEach(e=>{o.appendChild(createPostElement(e))}),newPostsDiv.appendChild(o)}function mergePendingPosts(){if(0===pendingPosts.length)return;let e=deduplicatePosts([...pendingPosts,...allPosts]);e=filterByDate(e,timeFilterHours),e=filterByLikes(e,minLikes),allPosts=sortPosts(e),clearNewPostHighlights(),newPostUris=new Set(pendingPosts.map(e=>e.uri)),scheduleNewPostHighlightClear(),pendingPosts=[],renderNewPosts(),renderResults()}function dismissPendingPosts(){0!==pendingPosts.length&&(pendingPosts=[],clearNewPostHighlights(),renderNewPosts(),renderResults())}async function refreshSearch(){if(0===searchTerms.length)return 0;let e=filterByDate(allPosts,timeFilterHours);e=filterByLikes(e,minLikes),allPosts=sortPosts(e),pendingPosts=filterByDate(pendingPosts,timeFilterHours),pendingPosts=filterByLikes(pendingPosts,minLikes);const t=new Set([...allPosts,...pendingPosts].map(e=>e.uri));let n=deduplicatePosts((await Promise.all(searchTerms.map(e=>fetchLatestPostsForTerm(e,searchSort)))).flat());n=filterByDate(n,timeFilterHours),n=filterByLikes(n,minLikes);const s=n.filter(e=>!t.has(e.uri));return s.length>0&&(pendingPosts=deduplicatePosts([...pendingPosts,...s])),clearNewPostHighlights(),s.length>0&&(newPostUris=new Set(s.map(e=>e.uri)),scheduleNewPostHighlightClear()),renderNewPosts(),renderResults(),s.length}async function runAutoRefresh(){if(autoRefreshEnabled)if(isLoading||isRefreshing)scheduleNextRefresh();else{if(0===searchTerms.length)return autoRefreshEnabled=!1,autoRefreshToggle.checked=!1,nextRefreshAt=null,lastRefreshError="Run a search first.",updateRefreshMeta(),void clearRefreshTimers();isRefreshing=!0,lastRefreshError=null,lastRefreshNewCount=null,updateRefreshMeta();try{const e=await refreshSearch();lastRefreshAt=new Date,lastRefreshNewCount=e}catch(e){console.error("Auto-refresh error:",e),lastRefreshError=e.message||"Refresh failed."}finally{isRefreshing=!1,scheduleNextRefresh()}}}function enableAutoRefresh(){if(0===searchTerms.length)return autoRefreshToggle.checked=!1,lastRefreshError="Run a search first.",void updateRefreshMeta();autoRefreshEnabled=!0,lastRefreshError=null,updateRefreshInterval(),scheduleNextRefresh()}function disableAutoRefresh(){autoRefreshEnabled=!1,clearRefreshTimers(),nextRefreshAt=null,updateRefreshMeta()}async function performSearch(){if(isLoading)return void(pendingSearch=!0);pendingSearch=!1;const e=termsInput.value.trim();if(!e)return void showStatus("Please enter at least one search term.","error");if(rawSearchTerms=e.split(",").map(normalizeTerm).filter(e=>e.length>0),searchTerms=expandSearchTerms(rawSearchTerms,expandTermsToggle.checked),minLikes=parseInt(minLikesInput.value)||0,timeFilterHours=parseInt(timeFilterSelect.value)||24,searchSort="latest"===sortSelect.value?"latest":"top",0===rawSearchTerms.length)return void showStatus("Please enter at least one search term.","error");isLoading=!0,searchBtn.disabled=!0;let t=!1;allPosts=[],currentCursors={},resultsDiv.textContent="",clearNewPostHighlights(),pendingPosts=[],renderNewPosts(),resetRenderLimit(),updateSearchURL();try{showStatus(`Searching for: ${rawSearchTerms.join(", ")}...`,"loading");const e=searchTerms.map(e=>fetchAllPostsForTerm(e,2,searchSort));let n=(await Promise.all(e)).flat();n=deduplicatePosts(n),n=filterByDate(n,timeFilterHours),n=filterByLikes(n,minLikes),allPosts=sortPosts(n),lastRefreshAt=new Date,lastRefreshNewCount=null,lastRefreshError=null,t=!0,updateRefreshMeta(),hideStatus(),renderResults()}catch(e){console.error("Search error:",e),showStatus(`Error: ${e.message}`,"error")}finally{isLoading=!1,searchBtn.disabled=!1,autoRefreshEnabled&&t&&scheduleNextRefresh(),pendingSearch&&(pendingSearch=!1,performSearch())}}async function loadMore(){if(isLoading)return;const e=allPosts.length;isLoading=!0;const t=document.getElementById("loadMoreBtn");t&&(t.disabled=!0,t.textContent="Loading...");try{const n=searchTerms.filter(e=>currentCursors[e]).map(async e=>{const t=await searchTerm(e,currentCursors[e],searchSort);return currentCursors[e]=t.cursor||null,t.posts&&t.posts.length>0?t.posts.map(t=>({...t,matchedTerm:e})):[]});let s=(await Promise.all(n)).flat();if(s.length>0){let t=[...allPosts,...s];t=deduplicatePosts(t),t=filterByDate(t,timeFilterHours),t=filterByLikes(t,minLikes),allPosts=sortPosts(t),allPosts.length>e&&(renderLimit=Math.min(allPosts.length,renderLimit+100)),renderResults()}else t&&t.remove()}catch(e){console.error("Load more error:",e),showStatus(`Error loading more: ${e.message}`,"error")}finally{isLoading=!1}}function debouncedSearch(){searchDebounceTimer&&clearTimeout(searchDebounceTimer),searchDebounceTimer=setTimeout(()=>{searchDebounceTimer=null,performSearch()},300)}function cancelDebouncedSearch(){searchDebounceTimer&&(clearTimeout(searchDebounceTimer),searchDebounceTimer=null)}searchBtn.addEventListener("click",()=>{cancelDebouncedSearch(),performSearch()}),quoteForm.addEventListener("submit",e=>{e.preventDefault(),performQuoteSearch()}),themeSelect.addEventListener("change",e=>{const t=e.target.value;localStorage.setItem("bsky-theme",t),applyThemePreference(t)}),prefersDarkScheme.addEventListener("change",()=>{"system"===themeSelect.value&&applyThemePreference("system")}),autoRefreshToggle.addEventListener("change",e=>{e.target.checked?enableAutoRefresh():disableAutoRefresh()}),refreshIntervalSelect.addEventListener("change",()=>{updateRefreshInterval(),autoRefreshEnabled?scheduleNextRefresh():updateRefreshMeta()}),sortSelect.addEventListener("change",()=>{searchSort="latest"===sortSelect.value?"latest":"top",autoRefreshEnabled&&scheduleNextRefresh()}),quoteTabs.addEventListener("click",e=>{if(!e.target.classList.contains("quote-tab"))return;const t=e.target.dataset.sort;t&&t!==quoteSort&&(quoteSort=t,updateQuoteTabs(),updateQuoteURL(),renderQuoteResults())}),termsInput.addEventListener("keypress",e=>{"Enter"===e.key&&(cancelDebouncedSearch(),performSearch())}),termsInput.addEventListener("input",()=>{if(updateExpansionSummary(),!termsInput.value.trim())return cancelDebouncedSearch(),void(pendingSearch=!1);debouncedSearch()}),minLikesInput.addEventListener("keypress",e=>{"Enter"===e.key&&(cancelDebouncedSearch(),performSearch())}),minLikesInput.addEventListener("input",debouncedSearch),expandTermsToggle.addEventListener("change",()=>{updateSearchURL(),updateExpansionSummary()}),initTheme(),initFromURL(),updateRefreshInterval(),updateRefreshMeta(),updateExpansionSummary();